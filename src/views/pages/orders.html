<!DOCTYPE html>
<html lang="id">

<head>
    <title>Orders - Baitybites OMS</title>
    {{> head_shared }}
</head>

<body class="page_orders">
    <div class="page-wrapper">
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <a href="/" class="logo">
                        <img src="/assets/logo.png" alt="Baitybites Logo">
                    </a>
                    <nav class="nav" id="mainNav"></nav>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="container">
                <div class="flex justify-between items-center mb-4 mt-4">
                    <div>
                        <h1 class="animate-fade-in">Orders</h1>
                        <p class="text-muted">Kelola semua pesanan pelanggan Baitybites</p>
                    </div>
                </div>

                <div class="card bg-transparent shadow-none border-0 p-0">
                    <div class="card-header flex-col bg-white rounded-xl shadow-sm border border-neutral-200 p-4 mb-6">
                        <div class="flex justify-between items-center w-full mb-3">
                            <input type="text" id="searchInput" class="form-input search-input-small"
                                placeholder="Search orders...">
                        </div>
                        <div class="tabs-container" id="statusTabs">
                            <button class="tab-btn active" data-status="">All</button>
                            <button class="tab-btn" data-status="pending">Pending</button>
                            <button class="tab-btn" data-status="confirmed">Confirmed</button>
                            <button class="tab-btn" data-status="production">Production</button>
                            <button class="tab-btn" data-status="packaging">Packaging</button>
                            <button class="tab-btn" data-status="shipping">Shipping</button>
                            <button class="tab-btn" data-status="completed">Completed</button>
                        </div>
                    </div>

                    <div id="ordersGrid" class="grid grid-3">
                        <!-- Orders will be rendered here -->
                        <div class="col-span-3 text-center py-12">
                            <div class="spinner mx-auto"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- New Order Detail Modal (Refactored) -->
        <div id="orderModal" class="modal-overlay" style="display: none;">
            <div class="modal modal-lg">
                <button class="modal-close modal-close-fixed" onclick="closeOrderModal()">&times;</button>
                <div class="modal-body" id="modalContent">
                    <!-- Content injected by JS -->
                </div>
            </div>
        </div>

        {{> footer_admin }}
    </div>

    <script src="/js/app.js?v={{VERSION}}"></script>
    <script>
        let allOrders = [];
        const STATUS_FLOW = ['pending', 'confirmed', 'production', 'packaging', 'shipping', 'completed'];
        const STATUS_LABELS = {
            'pending': 'Pending',
            'confirmed': 'Confirmed',
            'production': 'Production',
            'packaging': 'Packaging',
            'shipping': 'Shipping',
            'completed': 'Arrived'
        };

        const STATUS_ICONS = {
            'pending': 'clock',
            'confirmed': 'credit-card',
            'production': 'flame',
            'packaging': 'package',
            'shipping': 'truck',
            'completed': 'check-circle'
        };

        document.addEventListener('DOMContentLoaded', async () => {
            setupFilters();
            await loadOrders();

            // Handle ID from URL to auto-open modal
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('id');
            if (orderId) {
                openOrderModal(Number(orderId));
            }

            // document.getElementById('orderModal').addEventListener('click', (e) => {
            //     if (e.target === document.getElementById('orderModal')) {
            //         closeOrderModal();
            //     }
            // });
        });

        function setupFilters() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', () => filterOrders());

            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    tabButtons.forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    filterOrders();
                });
            });
        }

        async function loadOrders() {
            const grid = document.getElementById('ordersGrid');
            try {
                const response = await window.app.apiCall('/orders');
                if (response.success) {
                    allOrders = response.data;
                    renderOrders(allOrders);
                } else {
                    allOrders = [];
                    renderEmptyState("Belum ada data pesanan.");
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                grid.innerHTML = `<div class="col-span-3 text-center text-danger">Gagal memuat data pesanan.</div>`;
            }
        }

        function filterOrders() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const activeStatus = document.querySelector('.tab-btn.active').dataset.status;

            const filtered = allOrders.filter(order => {
                const matchesSearch =
                    order.order_number.toLowerCase().includes(searchTerm) ||
                    order.customer_name.toLowerCase().includes(searchTerm) ||
                    order.customer_email.toLowerCase().includes(searchTerm);

                const matchesStatus = activeStatus === '' || order.status === activeStatus;

                return matchesSearch && matchesStatus;
            });

            if (filtered.length > 0) {
                renderOrders(filtered);
            } else {
                renderEmptyState("Tidak ada pesanan yang cocok.");
            }
        }

        function renderOrders(orders) {
            const grid = document.getElementById('ordersGrid');
            grid.innerHTML = orders.map(order => {
                const progress = getProgressPercentage(order.status);
                const color = getStatusColor(order.status);
                const itemsCount = (order.items && order.items.length) || 0;
                const firstItem = (order.items && order.items[0]) ? order.items[0].product_name : 'No items';
                const moreItems = itemsCount > 1 ? `+${itemsCount - 1} more` : '';

                return `
                <div class="order-card animate-fade-in" onclick="openOrderModal(${order.id})">
                    <div class="order-card-header">
                        <span class="order-number">#${order.order_number}</span>
                        <span class="badge ${window.app.getStatusBadgeClass(order.status)}">${window.app.getStatusLabel(order.status)}</span>
                    </div>
                    
                    <div class="order-customer">
                        <div class="customer-name">${order.customer_name}</div>
                        <div class="customer-email">${order.customer_email}</div>
                    </div>

                    <div class="order-products">
                        <div class="product-item">
                            <span>${firstItem}</span>
                            ${moreItems ? `<span class="text-xs bg-neutral-100 px-2 py-1 rounded-full text-neutral-600">${moreItems}</span>` : ''}
                        </div>
                    </div>

                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Progress</span>
                            <span>${progress}%</span>
                        </div>
                        <div class="progress-track">
                            <div class="progress-fill" style="width: ${progress}%; --fill-bg: ${color}"></div>
                        </div>
                    </div>
                </div>
            `}).join('');
            lucide.createIcons();
        }

        function renderEmptyState(message) {
            const grid = document.getElementById('ordersGrid');
            grid.innerHTML = `<div class="col-span-3 text-center text-muted py-12">${message}</div>`;
        }

        function getProgressPercentage(status) {
            const map = {
                'pending': 10, 'confirmed': 25, 'production': 50,
                'packaging': 75, 'shipping': 90, 'completed': 100, 'cancelled': 0
            };
            return map[status] || 0;
        }

        function getStatusColor(status) {
            const map = {
                'pending': 'var(--primary-600)', 'confirmed': '#3b82f6', 'production': '#8b5cf6',
                'packaging': '#f97316', 'shipping': '#06b6d4', 'completed': '#10b981', 'cancelled': '#ef4444'
            };
            return map[status] || '#9ca3af';
        }

        function openOrderModal(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            const modalContent = document.getElementById('modalContent');

            // Generate Items HTML
            const itemsHtml = order.items ? order.items.map(item => `
                <div class="order-item-row">
                    <span class="item-name">${item.product_name}</span>
                    <span class="item-qty">${item.quantity} pcs</span>
                </div>
            `).join('') : '<p class="text-muted">No items found</p>';

            // Generate Progress Tracker HTML
            let trackerHtml = '';
            let currentStepIndex = STATUS_FLOW.indexOf(order.status);
            // Handling edge cases or cancelled
            if (currentStepIndex === -1) currentStepIndex = 0;

            // Calculate progress line width
            // 5 segments (between 6 nodes). 100% / 5 = 20% per segment.
            // Width = index * 20
            const progressWidth = currentStepIndex * 20;

            trackerHtml = `
                <div class="tracker-container">
                    <div class="tracker-line"></div>
                    <div class="tracker-line-progress" style="--p: ${progressWidth}%;"></div>
                    ${STATUS_FLOW.map((step, index) => {
                let stateClass = '';
                if (index < currentStepIndex) stateClass = 'is-done';
                if (index === currentStepIndex) stateClass = 'active';

                // Click to update status (mock functionality)
                const action = `onclick="updateStatus(${order.id}, '${step}')" title="Set to ${step}"`;

                const statusColor = getStatusColor(step);
                // We use inline variables to ensure the active theme matches the status color perfectly
                return `
                        <div class="tracker-step ${stateClass} ${step}" ${action} 
                             style="--active-status-color: ${statusColor}; --active-status-bg: ${statusColor}15; --active-status-border: ${statusColor}33; --active-status-shadow: ${statusColor}20;">
                            <div class="step-label">${STATUS_LABELS[step]}</div>
                            <div class="step-dot"></div>
                            <div class="step-icon">
                                <i data-lucide="${STATUS_ICONS[step]}"></i>
                            </div>
                        </div>
                        `;
            }).join('')}
                </div>
            `;

            modalContent.innerHTML = `
                <div class="modal-new-header">
                    <div class="modal-order-info">
                        <h5>Order #${order.order_number}</h5>
                        <div class="modal-order-date">${window.app.formatDateTime(order.order_date)}</div>
                    </div>
                    <div class="modal-status-badge" style="--badge-bg: ${getStatusColor(order.status)}">
                        ${window.app.getStatusLabel(order.status)}
                    </div>
                </div>

                <div class="modal-new-body">
                    <div class="customer-section">
                        <h3>${order.customer_name}</h3>
                        <div class="customer-detail">
                            <p>${order.customer_email}</p>
                            <!-- Placeholder for phone/address if available in future -->
                        </div>
                    </div>

                    <div class="items-section">
                        <div class="order-items-list">
                            ${itemsHtml}
                        </div>
                        <div class="order-total-section">
                            <div class="total-amount">${window.app.formatCurrency(order.total_amount)}</div>
                        </div>
                    </div>
                </div>

                ${trackerHtml}
            `;

            const modal = document.getElementById('orderModal');
            modal.classList.add('active');
            modal.style.display = 'flex';
            lucide.createIcons();
        }

        function closeOrderModal() {
            const modal = document.getElementById('orderModal');
            modal.classList.remove('active');
            modal.style.display = 'none';
        }

        async function updateStatus(orderId, newStatus) {
            if (!confirm(`Update status to ${STATUS_LABELS[newStatus]}?`)) return;

            // Mock update
            const order = allOrders.find(o => o.id === orderId);
            if (order) {
                order.status = newStatus;
                renderOrders(allOrders); // helper to re-render grid
                openOrderModal(orderId); // helper to re-render modal
            }
        }
    </script>
</body>

</html>