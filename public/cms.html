<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS - Kelola Konten Baitybites</title>
    <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#f59638">
    <link rel="stylesheet" href="/css/main.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <div class="cms-grid">
        <aside class="sidebar">
            <div class="mb-4 text-center">
                <img src="/assets/logo.png" alt="Logo" class="sidebar-logo">
                <h3 class="mt-2 text-white">Admin CMS</h3>
            </div>
            <nav class="sidebar-nav">
                <a href="#orders" class="active" onclick="switchSection('orders', event)"><i data-lucide="package"
                        class="sidebar-icon"></i> Kelola Pesanan</a>
                <a href="#gallery" onclick="switchSection('gallery', event)"><i data-lucide="image"
                        class="sidebar-icon"></i> Galeri Foto</a>
                <a href="#instagram" onclick="switchSection('instagram', event)"><i data-lucide="instagram"
                        class="sidebar-icon"></i> Instagram Settings</a>
                <a href="#settings" onclick="switchSection('settings', event)"><i data-lucide="settings"
                        class="sidebar-icon"></i> Setting Kontak</a>
                <a href="#testimonials" onclick="switchSection('testimonials', event)"><i data-lucide="message-square"
                        class="sidebar-icon"></i> Moderasi Testimoni</a>
                <a href="/kitchen.html" class="sidebar-link"><i data-lucide="utensils-crosses" class="sidebar-icon"></i>
                    Kitchen View</a>
                <a href="/dashboard" class="nav-back mt-4"><i data-lucide="arrow-left" class="sidebar-icon"></i>
                    Dashboard Utama</a>
            </nav>
        </aside>

        <main class="content-area">
            <!-- Pesanan Section -->
            <section id="orders-section" class="section-card">
                <div class="flex justify-between items-center mb-4">
                    <h2>Manajemen Pesanan & Progress</h2>
                    <button class="btn btn-primary btn-sm" onclick="loadOrders()">Refresh Data</button>
                </div>
                <div class="table-wrapper">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Customer</th>
                                <th style="text-align: center;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="orders-list"></tbody>
                    </table>
                </div>
            </section>

            <!-- Testimonials Section -->
            <section id="testimonials-section" class="section-card" style="display:none;">
                <h2>Moderasi Testimoni</h2>
                <div id="testimonials-list"></div>
            </section>

            <!-- Gallery Section -->
            <section id="gallery-section" class="section-card" style="display:none;">
                <div class="flex justify-between items-center mb-4">
                    <h2>Manajemen Galeri</h2>
                    <button class="btn btn-secondary btn-sm" onclick="showGalleryModal()">Tambah Foto</button>
                </div>
                <div class="gallery-preview" id="gallery-list"></div>
            </section>

            <!-- Instagram Settings Section -->
            <section id="instagram-section" class="section-card" style="display:none;">
                <div class="mb-4">
                    <h2><i data-lucide="instagram" style="vertical-align: middle; margin-right: 8px;"></i> Instagram
                        Integration</h2>
                    <p class="text-muted">Pilih salah satu metode integrasi Instagram di bawah ini</p>
                </div>

                <!-- Option 1: Elfsight Widget (Recommended) -->
                <div class="ig-integration-card">
                    <h4><i data-lucide="sparkles" size="18" style="vertical-align: middle;"></i> Opsi 1: Elfsight Widget
                        (Direkomendasikan - Paling Mudah)</h4>
                    <p>
                        Cara tercepat dan termudah tanpa perlu API token. Cukup copy-paste widget code dari Elfsight.
                    </p>
                    <ol style="line-height: 1.8;">
                        <li>Buka <a href="https://elfsight.com/instagram-feed-instashow/" target="_blank">Elfsight
                                Instagram Feed</a></li>
                        <li>Buat widget Instagram Feed gratis atau berbayar</li>
                        <li>Salin kode widget yang diberikan</li>
                        <li>Paste di kolom bawah ini</li>
                    </ol>

                    <div class="editable-field" id="field-elfsightWidget">
                        <label class="field-label">Elfsight Widget Code</label>
                        <div class="field-display">
                            <div class="field-value-text" id="text-elfsightWidget">Loading...</div>
                            <button type="button" class="btn-edit-inline" onclick="startInlineEdit('elfsightWidget')"><i
                                    data-lucide="edit-3"></i></button>
                        </div>
                        <div class="field-edit-box">
                            <textarea id="elfsightWidget" class="form-input" rows="5"></textarea>
                            <div class="edit-controls">
                                <button type="button" class="btn btn-outline btn-xs"
                                    onclick="cancelInlineEdit('elfsightWidget')">Batal</button>
                                <button type="button" class="btn btn-primary btn-xs"
                                    onclick="saveElfsightWidget()">Simpan</button>
                            </div>
                        </div>
                    </div>
                    <div id="elfsightStatus" class="mt-2"></div>
                </div>

                <!-- Option 2: API Integration (Advanced) -->
                <div class="ig-integration-card api">
                    <h4><i data-lucide="settings" size="18" style="vertical-align: middle;"></i> Opsi 2: API Integration
                        (Advanced)</h4>
                    <p>
                        Sinkronisasi otomatis galeri dari Instagram: 3 post terbaru + 3 post terpopuler
                    </p>
                    <details>
                        <summary class="detail-summary"><i data-lucide="file-text" size="16"></i> Cara Mendapatkan
                            Access Token</summary>
                        <ol style="line-height: 1.8; margin-top: 10px;">
                            <li>Buka <a href="https://developers.facebook.com/apps/" target="_blank">Facebook for
                                    Developers</a></li>
                            <li>Buat atau pilih App yang terhubung dengan akun Instagram Business</li>
                            <li>Di Graph API Explorer, generate token dengan permissions: <code>instagram_basic</code>,
                                <code>pages_read_engagement</code>
                            </li>
                            <li>Salin Long-Lived Access Token dan paste di bawah</li>
                        </ol>
                    </details>

                    <div class="form-group mt-3">
                        <label class="form-label">Instagram Access Token</label>
                        <input type="password" id="igToken" class="form-input"
                            placeholder="Paste your Instagram Graph API token here">
                        <small class="text-muted" id="tokenStatus"></small>
                    </div>

                    <div class="flex gap-2">
                        <button class="btn btn-primary" onclick="saveInstagramToken()"><i data-lucide="save"
                                size="16"></i> Simpan Token</button>
                        <button class="btn btn-secondary" onclick="syncInstagram()"><i data-lucide="refresh-cw"
                                size="16"></i> Sinkronkan Sekarang</button>
                    </div>

                    <div id="syncStatus" class="mt-4"></div>
                </div>
            </section>

            <!-- General Settings Section -->
            <section id="settings-section" class="section-card" style="display:none;">
                <div class="mb-4">
                    <h2><i data-lucide="cog" size="24" style="vertical-align: middle;"></i> Pengaturan Kontak & Sosial
                        Media</h2>
                    <p class="text-muted">Informasi ini akan ditampilkan di footer website.</p>
                </div>

                <form id="settingsForm" onsubmit="event.preventDefault();">
                    <div class="grid grid-2 gap-4">
                        <div>
                            <h4 class="mb-3"><i data-lucide="phone" size="18"></i> Kontak Informasi</h4>

                            <div class="editable-field" id="field-contact_email">
                                <label class="field-label">Email Support</label>
                                <div class="field-display">
                                    <div class="field-value-text" id="text-contact_email">---</div>
                                    <button type="button" class="btn-edit-inline"
                                        onclick="startInlineEdit('contact_email')"> <i data-lucide="edit-3"
                                            size="14"></i></button>
                                </div>
                                <div class="field-edit-box">
                                    <input type="email" id="contact_email" class="form-input">
                                    <div class="edit-controls">
                                        <button type="button" class="btn btn-outline btn-xs"
                                            onclick="cancelInlineEdit('contact_email')">Batal</button>
                                        <button type="button" class="btn btn-primary btn-xs"
                                            onclick="saveIndividualSetting('contact_email')">Simpan</button>
                                    </div>
                                </div>
                            </div>

                            <div class="editable-field" id="field-contact_phone">
                                <label class="field-label">Nomor WhatsApp / Telepon</label>
                                <div class="field-display">
                                    <div class="field-value-text" id="text-contact_phone">---</div>
                                    <button type="button" class="btn-edit-inline"
                                        onclick="startInlineEdit('contact_phone')"> <i data-lucide="edit-3"
                                            size="14"></i></button>
                                </div>
                                <div class="field-edit-box">
                                    <input type="text" id="contact_phone" class="form-input">
                                    <div class="edit-controls">
                                        <button type="button" class="btn btn-outline btn-xs"
                                            onclick="cancelInlineEdit('contact_phone')">Batal</button>
                                        <button type="button" class="btn btn-primary btn-xs"
                                            onclick="saveIndividualSetting('contact_phone')">Simpan</button>
                                    </div>
                                </div>
                            </div>

                            <div class="editable-field" id="field-contact_address">
                                <label class="field-label">Alamat Fisik</label>
                                <div class="field-display">
                                    <div class="field-value-text" id="text-contact_address"
                                        style="white-space: pre-wrap;">---</div>
                                    <button type="button" class="btn-edit-inline"
                                        onclick="startInlineEdit('contact_address')"> <i data-lucide="edit-3"
                                            size="14"></i></button>
                                </div>
                                <div class="field-edit-box">
                                    <textarea id="contact_address" class="form-input" rows="3"></textarea>
                                    <div class="edit-controls">
                                        <button type="button" class="btn btn-outline btn-xs"
                                            onclick="cancelInlineEdit('contact_address')">Batal</button>
                                        <button type="button" class="btn btn-primary btn-xs"
                                            onclick="saveIndividualSetting('contact_address')">Simpan</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h4 class="mb-3"><i data-lucide="globe" size="18"></i> Sosial Media (Username/Link)</h4>

                            <div class="editable-field" id="field-social_instagram">
                                <label class="field-label">Instagram URL</label>
                                <div class="field-display">
                                    <div class="field-value-text" id="text-social_instagram">---</div>
                                    <button type="button" class="btn-edit-inline"
                                        onclick="startInlineEdit('social_instagram')"> <i data-lucide="edit-3"
                                            size="14"></i></button>
                                </div>
                                <div class="field-edit-box">
                                    <input type="text" id="social_instagram" class="form-input">
                                    <div class="edit-controls">
                                        <button type="button" class="btn btn-outline btn-xs"
                                            onclick="cancelInlineEdit('social_instagram')">Batal</button>
                                        <button type="button" class="btn btn-primary btn-xs"
                                            onclick="saveIndividualSetting('social_instagram')">Simpan</button>
                                    </div>
                                </div>
                            </div>

                            <div class="editable-field" id="field-social_facebook">
                                <label class="field-label">Facebook URL</label>
                                <div class="field-display">
                                    <div class="field-value-text" id="text-social_facebook">---</div>
                                    <button type="button" class="btn-edit-inline"
                                        onclick="startInlineEdit('social_facebook')"> <i data-lucide="edit-3"
                                            size="14"></i></button>
                                </div>
                                <div class="field-edit-box">
                                    <input type="text" id="social_facebook" class="form-input">
                                    <div class="edit-controls">
                                        <button type="button" class="btn btn-outline btn-xs"
                                            onclick="cancelInlineEdit('social_facebook')">Batal</button>
                                        <button type="button" class="btn btn-primary btn-xs"
                                            onclick="saveIndividualSetting('social_facebook')">Simpan</button>
                                    </div>
                                </div>
                            </div>

                            <div class="editable-field" id="field-social_tiktok">
                                <label class="field-label">TikTok URL</label>
                                <div class="field-display">
                                    <div class="field-value-text" id="text-social_tiktok">---</div>
                                    <button type="button" class="btn-edit-inline"
                                        onclick="startInlineEdit('social_tiktok')"> <i data-lucide="edit-3"
                                            size="14"></i></button>
                                </div>
                                <div class="field-edit-box">
                                    <input type="text" id="social_tiktok" class="form-input">
                                    <div class="edit-controls">
                                        <button type="button" class="btn btn-outline btn-xs"
                                            onclick="cancelInlineEdit('social_tiktok')">Batal</button>
                                        <button type="button" class="btn btn-primary btn-xs"
                                            onclick="saveIndividualSetting('social_tiktok')">Simpan</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </section>
        </main>
    </div>

    <!-- Gallery Modal -->
    <div id="galleryModal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; justify-content:center; align-items:center;">
        <div style="background:white; padding:30px; border-radius:12px; width:400px; max-width:90%;">
            <h3>Tambah Foto Galeri</h3>
            <form id="galleryForm" class="mt-4">
                <div class="form-group mb-3">
                    <label class="form-label">Pilih Foto</label>
                    <input type="file" id="galImage" class="form-input" accept="image/*" required>
                </div>
                <div class="form-group mb-3">
                    <label class="form-label">Judul (Opsional)</label>
                    <input type="text" id="galTitle" class="form-input" placeholder="Contoh: Risol Mayo Crispy">
                </div>
                <div class="form-group mb-3">
                    <label class="form-label">Urutan Tampilan</label>
                    <input type="number" id="galOrder" class="form-input" value="0">
                </div>
                <div class="flex gap-2 mt-4">
                    <button type="button" class="btn btn-outline" onclick="closeGalleryModal()"
                        style="flex:1;">Batal</button>
                    <button type="submit" class="btn btn-primary" style="flex:2;">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
        // apiCall is already globally available from app.js

        function switchSection(section, event) {
            if (event) event.preventDefault();

            document.getElementById('orders-section').style.display = section === 'orders' ? 'block' : 'none';
            document.getElementById('testimonials-section').style.display = section === 'testimonials' ? 'block' : 'none';
            document.getElementById('gallery-section').style.display = section === 'gallery' ? 'block' : 'none';
            document.getElementById('instagram-section').style.display = section === 'instagram' ? 'block' : 'none';
            document.getElementById('settings-section').style.display = section === 'settings' ? 'block' : 'none';

            document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));

            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            } else {
                // If no event (like on initial load), find the link matching the hash
                const link = document.querySelector(`.sidebar-nav a[href="#${section}"]`);
                if (link) link.classList.add('active');
            }

            if (section === 'orders') loadOrders();
            if (section === 'testimonials') loadTestimonials();
            if (section === 'gallery') loadGallery();
            if (section === 'instagram') loadInstagramSettings();
            if (section === 'settings') loadSettings();
        }

        const statusLabels = {
            'confirmed': 'Konfirmasi',
            'production': 'Mulai Produksi',
            'packaging': 'Pengemasan',
            'shipping': 'Pengiriman',
            'completed': 'Selesai'
        };

        async function loadOrders() {
            try {
                const json = await apiCall('/cms/orders');
                const container = document.getElementById('orders-list');
                if (json.success) {
                    container.innerHTML = json.data.map(o => {
                        const steps = ['confirmed', 'production', 'packaging', 'shipping', 'completed'];
                        const currentStepIndex = steps.indexOf(o.status);

                        const isCompleted = o.status === 'completed';

                        return `
                        <tr>
                            <td><strong>${o.order_number}</strong></td>
                            <td>${o.customer_name}</td>
                            <td style="text-align: center; overflow: visible;">
                                <div class="status-popover-container" id="popover-${o.id}">
                                    <button class="status-trigger-badge ${o.status} ${isCompleted ? 'is-completed' : ''}" 
                                            ${isCompleted ? '' : `onclick="toggleStatusPopover(event, ${o.id})"`}>
                                        ${o.status.toUpperCase()}
                                    </button>
                                    
                                    ${isCompleted ? '' : `
                                    <div class="status-popover ${o.status}">
                                        <div class="timeline-steps">
                                            ${steps.map((step, index) => {
                            let stateClass = '';
                            if (index < currentStepIndex) stateClass = 'completed';
                            else if (index === currentStepIndex) stateClass = 'current active';

                            return `
                                                <div class="timeline-step ${stateClass}" onclick="selectStatusFromTimeline(${o.id}, '${step}')">
                                                    <div class="step-circle" title="${statusLabels[step]}"></div>
                                                    <div class="step-label">${statusLabels[step]}</div>
                                                </div>
                                                `;
                        }).join('')}
                                        </div>
                                    </div>
                                    `}
                                </div>
                            </td>
                        </tr>
                    `}).join('');
                }
            } catch (e) { console.error(e); }
        }

        function toggleStatusPopover(e, id) {
            e.stopPropagation();
            // Close all others
            document.querySelectorAll('.status-popover').forEach(el => {
                const parent = el.closest('.status-popover-container');
                if (parent && parent.id !== `popover-${id}`) {
                    el.classList.remove('show');
                }
            });

            const container = document.getElementById(`popover-${id}`);
            const popover = container.querySelector('.status-popover');
            popover.classList.toggle('show');
        }

        function selectStatusFromTimeline(id, status) {
            updateStatus(id, status);

            // Close popover
            const container = document.getElementById(`popover-${id}`);
            const popover = container.querySelector('.status-popover');
            popover.classList.remove('show');
        }

        async function updateStatus(id, status) {
            if (!status) return;
            try {
                const res = await apiCall('/cms/orders/' + id + '/status', {
                    method: 'PUT',
                    body: JSON.stringify({ status })
                });
                if (res.success) {
                    // alert('Status diperbarui!'); // Removed for smoother UX
                    loadOrders();
                }
            } catch (e) { console.error(e); }
        }

        async function loadTestimonials() {
            try {
                const json = await apiCall('/cms/testimonials');
                const container = document.getElementById('testimonials-list');
                if (json.success) {
                    container.innerHTML = json.data.map(t => `
                        <div class="testimonial-item">
                            <div class="testimonial-content">
                                <div class="testimonial-header">
                                    <strong>${t.name}</strong>
                                    <span class="role-badge">${t.role}</span>
                                </div>
                                <p class="testimonial-text">"${t.content}"</p>
                            </div>
                            <div class="testimonial-actions">
                                <button class="btn ${t.is_approved ? 'btn-outline' : 'btn-primary'} btn-sm" 
                                        onclick="toggleApprove(${t.id}, ${!t.is_approved})">
                                    ${t.is_approved ? 'Batalkan' : 'Setujui'}
                                </button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function toggleApprove(id, is_approved) {
            try {
                const res = await apiCall('/cms/testimonials/' + id + '/approve', {
                    method: 'PUT',
                    body: JSON.stringify({ is_approved })
                });
                if (res.success) loadTestimonials();
            } catch (e) { console.error(e); }
        }

        async function loadGallery() {
            try {
                const json = await apiCall('/cms/gallery');
                const container = document.getElementById('gallery-list');
                if (json.success) {
                    container.innerHTML = json.data.map(g => `
                        <div class="gallery-item">
                            <img src="${g.image_url}" alt="${g.title}">
                            <div class="actions">
                                <div>
                                    <div class="badge ${g.source === 'instagram' ? 'badge-approved' : 'badge-pending'}" 
                                         style="font-size:0.6rem; margin-bottom:4px;">
                                        ${g.source === 'instagram' ? 'INSTAGRAM' : 'MANUAL'}
                                    </div>
                                    <div style="font-size:0.8rem;">Order: ${g.display_order}</div>
                                </div>
                                <button class="btn btn-danger btn-xs" onclick="deleteGallery(${g.id})">Hapus</button>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function deleteGallery(id) {
            if (!confirm('Hapus foto ini?')) return;
            try {
                const res = await apiCall('/cms/gallery/' + id, { method: 'DELETE' });
                if (res.success) loadGallery();
            } catch (e) { console.error(e); }
        }

        // Gallery Modal Logic
        function showGalleryModal() {
            document.getElementById('galleryModal').style.display = 'flex';
        }

        function closeGalleryModal() {
            document.getElementById('galleryModal').style.display = 'none';
            document.getElementById('galleryForm').reset();
        }

        document.getElementById('galleryForm').onsubmit = async (e) => {
            e.preventDefault();
            const formData = new FormData();
            formData.append('image', document.getElementById('galImage').files[0]);
            formData.append('title', document.getElementById('galTitle').value);
            formData.append('display_order', document.getElementById('galOrder').value);

            try {
                const res = await apiCall('/cms/gallery', {
                    method: 'POST',
                    body: formData
                });
                if (res.success) {
                    alert('Foto berhasil ditambahkan!');
                    closeGalleryModal();
                    loadGallery();
                }
            } catch (e) {
                console.error(e);
            }
        };

        // --- Elfsight Widget Functions ---
        function startInlineEdit(fieldId) {
            document.getElementById(`field-${fieldId}`).classList.add('is-editing');
            const input = document.getElementById(fieldId);
            input.focus();
            if (input.tagName === 'TEXTAREA') {
                input.setSelectionRange(input.value.length, input.value.length);
            }
        }

        function cancelInlineEdit(fieldId) {
            document.getElementById(`field-${fieldId}`).classList.remove('is-editing');
            // If it was a settings field, reload to undo local changes
            if (fieldId !== 'elfsightWidget') loadSettings();
            else loadInstagramSettings();
        }

        async function saveElfsightWidget() {
            const widget = document.getElementById('elfsightWidget').value.trim();
            if (!widget) {
                alert('Mohon masukkan kode widget Elfsight');
                return;
            }
            try {
                const res = await apiCall('/cms/instagram/widget', {
                    method: 'PUT',
                    body: JSON.stringify({ widget })
                });
                if (res.success) {
                    document.getElementById('text-elfsightWidget').textContent = widget;
                    cancelInlineEdit('elfsightWidget');
                    document.getElementById('elfsightStatus').innerHTML =
                        '<div class="badge badge-approved"><i data-lucide="check" size="12"></i> Tersimpan!</div>';
                    if (window.lucide) lucide.createIcons();
                    setTimeout(() => {
                        document.getElementById('elfsightStatus').innerHTML = '';
                    }, 3000);
                }
            } catch (e) {
                console.error(e);
                alert('Gagal menyimpan widget');
            }
        }

        // --- Instagram API Functions ---
        async function loadInstagramSettings() {
            try {
                const res = await apiCall('/cms/instagram/settings');
                if (res.success && res.data.has_token) {
                    document.getElementById('tokenStatus').innerHTML = '<span style="color: #10b981;"><i data-lucide="check-circle" size="14"></i> Token tersimpan</span>';
                    if (window.lucide) lucide.createIcons();
                }
                // Load widget if exists
                const widgetRes = await apiCall('/cms/instagram/widget');
                if (widgetRes.success && widgetRes.data) {
                    document.getElementById('elfsightWidget').value = widgetRes.data;
                    document.getElementById('text-elfsightWidget').textContent = widgetRes.data.substring(0, 50) + '...';
                } else {
                    document.getElementById('text-elfsightWidget').textContent = 'Belum ada widget';
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function saveInstagramToken() {
            const token = document.getElementById('igToken').value.trim();
            if (!token) {
                alert('Mohon masukkan access token');
                return;
            }
            try {
                const res = await apiCall('/cms/instagram/token', {
                    method: 'PUT',
                    body: JSON.stringify({ token })
                });
                if (res.success) {
                    document.getElementById('tokenStatus').textContent = '✅ Token berhasil disimpan';
                    document.getElementById('igToken').value = '';
                }
            } catch (e) {
                console.error(e);
                alert('Gagal menyimpan token');
            }
        }

        async function syncInstagram() {
            const statusEl = document.getElementById('syncStatus');
            statusEl.innerHTML = '<div class="badge badge-pending">⏳ Sedang sinkronisasi...</div>';
            try {
                const res = await apiCall('/cms/instagram/sync', { method: 'POST' });
                if (res.success) {
                    statusEl.innerHTML = '<div class="badge badge-approved">✅ ' + res.message + '</div>';
                    loadGallery(); // Refresh gallery
                } else {
                    statusEl.innerHTML = '<div class="badge badge-pending">❌ ' + res.message + '</div>';
                }
            } catch (e) {
                console.error(e);
                statusEl.innerHTML = '<div class="badge badge-pending">❌ Gagal sinkronisasi</div>';
            }
        }

        async function loadSettings() {
            try {
                const res = await apiCall('/cms/settings');
                if (res.success) {
                    const data = res.data;
                    const fields = ['contact_email', 'contact_phone', 'contact_address', 'social_instagram', 'social_facebook', 'social_tiktok'];

                    fields.forEach(f => {
                        const val = data[f] || '---';
                        document.getElementById(f).value = data[f] || '';
                        document.getElementById(`text-${f}`).textContent = val;
                    });
                }
            } catch (e) { console.error(e); }
        }

        async function saveIndividualSetting(fieldId) {
            const value = document.getElementById(fieldId).value;
            // Since the backend likely expects the full settings object, we'll fetch current values
            const payload = {
                contact_email: document.getElementById('contact_email').value,
                contact_phone: document.getElementById('contact_phone').value,
                contact_address: document.getElementById('contact_address').value,
                social_instagram: document.getElementById('social_instagram').value,
                social_facebook: document.getElementById('social_facebook').value,
                social_tiktok: document.getElementById('social_tiktok').value
            };

            try {
                const res = await apiCall('/cms/settings', {
                    method: 'PUT',
                    body: JSON.stringify(payload)
                });
                if (res.success) {
                    document.getElementById(`text-${fieldId}`).textContent = value || '---';
                    cancelInlineEdit(fieldId);
                }
            } catch (error) {
                console.error(error);
                alert('Gagal menyimpan perubahan');
            }
        }

        // Initial Load
        switchSection('orders');
        loadInstagramSettings();

        // Close popovers when clicking outside
        document.addEventListener('click', function (e) {
            if (!e.target.closest('.status-popover-container')) {
                document.querySelectorAll('.status-popover').forEach(el => el.classList.remove('show'));
            }
        });
    </script>
</body>

</html>
